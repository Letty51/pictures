# Hash MAC CBC-MAC HMAC AEAD GCM 笔记整理

[Letty51](https://github.com/letty51)

## Hash（Hash Function）

散列函数 Hash Function，又称散列算法、哈希函数，就是把任意长度的输入，通过 Hash 算法，变换成固定长度的输出，该输出就是散列值（Hash 值）。这种转换是一种压缩映射，Hash 值的空间通常远小于输入的空间。不同的输入可能会散列成相同的输出，这种情况称为碰撞。

![](https://github.com/Letty51/pictures/blob/master/Hash.png)

### Hash 函数分为两类：

- 改动检测码 MDC（Manipulation Detection Code），不带密钥的哈希函数，主要用于消息完整性验证；
- 消息验证码 MAC（Message Authentication Code），带密钥的哈希函数，主要用于消息源认证和消息完整性验证。

## MAC（Message Authentication Code）

消息验证码 MAC 是一种消息认证技术，用来检查一段信息、消息的可靠性和完整性。一个 MAC 算法接收一段任意长度的消息和一个固定长度的密钥 key，产生一个 MAC 值。
发送者传输的数据必然包含两个部分，即加密的数据部分以及消息验证码部分。
1. 发送者和接收者共享密钥 K，发送者通过 MAC 算法计算出消息的 MAC 值，并和原消息一起发给接收者；
2. 接收者对收到的消息用相同的密钥 K 进行相同的 MAC 计算得到 MAC 值，并与接收到的 MAC 值进行对比。若相等，则：
> - 接收者可以相信消息未被修改；
> - 接收者可以确信消息来自真正的发送者。

![](https://github.com/Letty51/pictures/blob/master/MAC.png)

### MAC 和 Encrypt 有三种结合使用的方式：

- Encrypt then MAC，先将明文加密，然后计算密文的 MAC，最后将密文和 MAC 值一起发送出去。
> <a href="https://www.codecogs.com/eqnedit.php?latex=\dpi{100}&space;\fn_cs&space;\large&space;C&space;=&space;E(K_c,P)\\&space;t&space;=&space;MAC(K_M,C)" target="_blank"><img src="https://latex.codecogs.com/png.latex?\dpi{100}&space;\fn_cs&space;\large&space;C&space;=&space;E(K_c,P)\\&space;t&space;=&space;MAC(K_M,C)" title="\large C = E(K_c,P)\\ t = MAC(K_M,C)" /></a>

![](https://github.com/Letty51/pictures/blob/master/Encrypt%20then%20MAC.png)

- MAC then encrypt，先计算明文的 MAC，然后把明文和计算出来的 MAC 值一块加密，最后将密文发送出去。
> <a href="https://www.codecogs.com/eqnedit.php?latex=\dpi{100}&space;\fn_cs&space;\large&space;t&space;=&space;MAC(K_M,P)\\&space;C&space;=&space;E(K_c,P||t)" target="_blank"><img src="https://latex.codecogs.com/png.latex?\dpi{100}&space;\fn_cs&space;\large&space;t&space;=&space;MAC(K_M,P)\\&space;C&space;=&space;E(K_c,P||t)" title="\large t = MAC(K_M,P)\\ C = E(K_c,P||t)" /></a>

![](https://github.com/Letty51/pictures/blob/master/MAC%20then%20Encrypt.png)

- Encrypt and MAC，分别对明文进行加密和 MAC 计算，最后分别将密文和 MAC 值发送出去。
> <a href="https://www.codecogs.com/eqnedit.php?latex=\dpi{100}&space;\fn_cs&space;\large&space;C&space;=&space;E(K_c,P)\\&space;t&space;=&space;MAC(K_M,P)" target="_blank"><img src="https://latex.codecogs.com/png.latex?\dpi{100}&space;\fn_cs&space;\large&space;C&space;=&space;E(K_c,P)\\&space;t&space;=&space;MAC(K_M,P)" title="\large C = E(K_c,P)\\ t = MAC(K_M,P)" /></a>

![](https://github.com/Letty51/pictures/blob/master/Encrypt%20and%20MAC.png)

总体来说，更推荐使用 Encrypt then MAC，优点在于收到密文和 MAC 值之后，可以先检验 MAC 值，如果不正确，就不用对密文进行解密了。MAC then encrypt 也可以使用，但是收到密文之后，必须先全部解密出来之后，才能校验消息是否完整。Encrypt and MAC 的安全性最差，通过 MAC 值就可以暴露出明文的一些特征，同样的明文会得到同样的 MAC 值。

MAC 算法包含 CBC-MAC，HMAC 等。

## CBC-MAC

CBC-MAC 的基本思想就是对消息使用 CBC 模式进行加密，取密文的最后一块作为 MAC 值。

![](https://github.com/Letty51/pictures/blob/master/CBC-MAC.png)

## HMAC（Hash-based Message Authentication Code）

散列消息鉴别码 HMAC，主要利用 Hash 算法，以一个密钥和一个消息为输入，生成一个固定大小的消息摘要，并将其加入到消息中作为输出。HMAC 算法可以与任何迭代 Hash 函数捆绑使用，例如 MD5 和 SHA-1 函数。HMAC 是目前最常用，也是目前比较安全的一种 MAC 算法。其安全性依赖于 Hash 函数，故也称为带密钥的 Hash 函数。

<a href="https://www.codecogs.com/eqnedit.php?latex=\dpi{100}&space;\fn_cs&space;\large&space;HMAC(K,M)&space;=&space;H(K&space;\oplus&space;opad&space;||&space;H(K&space;\oplus&space;ipad)&space;||&space;M){\color{Pink}&space;{\color{Red}&space;}}" target="_blank"><img src="https://latex.codecogs.com/png.latex?\dpi{100}&space;\fn_cs&space;\large&space;HMAC(K,M)&space;=&space;H(K&space;\oplus&space;opad&space;||&space;H(K&space;\oplus&space;ipad)&space;||&space;M){\color{Pink}&space;{\color{Red}&space;}}" title="\large HMAC(K,M) = H(K \oplus opad || H(K \oplus ipad) || M){\color{Pink} {\color{Red} }}" /></a>
> <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;\large&space;H" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;\large&space;H" title="\large H" /></a> ：采用 Hash 算法得到的散列值 \
> <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;\large&space;K" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;\large&space;K" title="\large K" /></a> ：密钥 \
> <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;\large&space;M" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;\large&space;M" title="\large M" /></a> ：一个消息输入 \
> <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;\large&space;opad" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;\large&space;opad" title="\large opad" /></a> ：外部填充（0x5c5c5c…5c，0x5c 重复 B 次） \
> <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;\large&space;ipad" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;\large&space;ipad" title="\large ipad" /></a> ：内部填充（0x363636…36，0x36 重复 B 次） \
> <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;\large&space;B" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;\large&space;B" title="\large B" /></a> ： 中所处理的块大小（MD5、SHA-1、SHA-256 处理的块大小为 64 Bytes；SHA-384、SHA-512 处理的块大小为 128 Bytes） \
> <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;\large&space;L" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;\large&space;L" title="\large L" /></a> ：最后输出的 MAC 值的大小（MD5 的输出大小为 128 bits；SHA-1 的输出大小为 160 bits；SHA-256 的输出大小为 256 bits; SHA-384 的输出大小为 384 bits …）

![](https://github.com/Letty51/pictures/blob/master/HMAC.png)

Step 1：对密钥 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;K" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;K" title="K" /></a> 进行处理：如果密钥长度小于 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;B" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;B" title="B" /></a>，就在密钥 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;K" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;K" title="K" /></a> 后面填充 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;0" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;0" title="0" /></a> 来生成一个长为 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;B" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;B" title="B" /></a> 的子密钥；如果密钥长度大于 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;B" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;B" title="B" /></a>，就先对密钥进行 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;Hash" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;Hash" title="Hash" /></a> 计算。（<a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;K" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;K" title="K" /></a> 可以有不超过 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;B" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;B" title="B" /></a> 字节的任意长度，但一般建议其长度不小于 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;L" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;L" title="L" /></a>。） \
Step 2：将子密钥与 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;ipad" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;ipad" title="ipad" /></a> 进行异或运算生成 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;S_1" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;S_1" title="S_1" /></a>； \
Step 3：将消息输入 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;M" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;M" title="M" /></a> 填充到 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;S_1" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;S_1" title="S_1" /></a> 之后； \
Step 4：对 Step 3 中生成的数据流进行 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;Hash" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;Hash" title="Hash" /></a> 计算； \
Step 5：将子密钥与 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;opad" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;opad" title="opad" /></a> 进行异或运算生成 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;S_2" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;S_2" title="S_2" /></a>； \
Step 6：将 Step 4 中生成的 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;Hash" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;Hash" title="Hash" /></a> 值填充到 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;S_2" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;S_2" title="S_2" /></a> 之后； \
Step 7：对 Step 6 中生成的数据流进行 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;Hash" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;Hash" title="Hash" /></a> 计算，输出最终结果。

## AEAD（Authenticated-Encryption With Additional Data）

带附加数据的认证加密模式 AEAD 的作用类似于 Encrypt then MAC，GCM 加密模式就是 AEAD 的一种。

## GCM（Galois/Counter Mode）

GCM 的设计思路是利用 CTR 模式和泛 Hash 设计 MAC 算法。其中泛 Hash 的运算是在二元域上的操作，因此软硬件实现代价小，速度快。

先决条件：
> - 允许使用分组大小为 128-bit 的分组加密算法 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;CIPH" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;CIPH" title="CIPH" /></a>；
> - 密钥 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;K" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;K" title="K" /></a>；
> - 定义支持的输入、输出长度；
> - 支持的 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;tag" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;tag" title="tag" /></a> 长度 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;t" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;t" title="t" /></a>，与密钥相关。

输入：
> - 初始化向量 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;IV" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;IV" title="IV" /></a>；
> - 明文 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;P" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;P" title="P" /></a>；
> - 附加验证数据 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;A" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;A" title="A" /></a>。

输出：
> - 密文 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;C" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;C" title="C" /></a>；
> - 验证码 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;T" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;T" title="T" /></a>。

![](https://github.com/Letty51/pictures/blob/master/GCM-AE.png)

Step 1：使用密钥 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;K" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;K" title="K" /></a> 通过分组加密算法 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;CIPH" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;CIPH" title="CIPH" /></a> 生成 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;Hash" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;Hash" title="Hash" /></a> 函数的子密钥 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;H&space;=&space;CIPH_K(0^{128})" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;H&space;=&space;CIPH_K(0^{128})" title="H = CIPH_K(0^{128})" /></a>；\
Step 2：根据初始化向量 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;IV" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;IV" title="IV" /></a> 得到计数器的预设值 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;J_0" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;J_0" title="J_0" /></a>；
> - 如果 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;IV" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;IV" title="IV" /></a> 的长度等于 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;96\&space;bits" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;96\&space;bits" title="96\ bits" /></a>，则 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;J_0&space;=&space;IV&space;||&space;0^{31}&space;||&space;1" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;J_0&space;=&space;IV&space;||&space;0^{31}&space;||&space;1" title="J_0 = IV || 0^{31} || 1" /></a>；
> - 如果 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;IV" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;IV" title="IV" /></a> 的长度不等于 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;96\&space;bits" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;96\&space;bits" title="96\ bits" /></a>，则在 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;IV" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;IV" title="IV" /></a> 后面填充 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;s&space;=&space;128\lceil&space;len(IV)/128\rceil&space;-&space;len(IV)" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;s&space;=&space;128\lceil&space;len(IV)/128\rceil&space;-&space;len(IV)" title="s = 128\lceil len(IV)/128\rceil - len(IV)" /></a> 个 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;0" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;0" title="0" /></a> ，直至其长度为 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;128\&space;bits" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;128\&space;bits" title="128\ bits" /></a> 的整数倍，并在其后增加 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;64\&space;bits" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;64\&space;bits" title="64\ bits" /></a> 来表示原始 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;IV" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;IV" title="IV" /></a> 的长度，最后使用子密钥 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;H" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;H" title="H" /></a> 通过 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;GHASH_H" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;GHASH_H" title="GHASH_H" /></a> 函数生成 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;J_0&space;=&space;GHASH_H(IV&space;||&space;0^{s&plus;64}&space;||&space;[len(iv)]_{64})" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;J_0&space;=&space;GHASH_H(IV&space;||&space;0^{s&plus;64}&space;||&space;[len(iv)]_{64})" title="J_0 = GHASH_H(IV || 0^{s+64} || [len(iv)]_{64})" /></a>。

Step 3：通过 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;GCTR_K" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;GCTR_K" title="GCTR_K" /></a> 函数生成密文 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;C&space;=&space;GCTR_K(inc_{32}(J_0),&space;P)" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;C&space;=&space;GCTR_K(inc_{32}(J_0),&space;P)" title="C = GCTR_K(inc_{32}(J_0), P)" /></a>，其中 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;inc_{32}" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;inc_{32}" title="inc_{32}" /></a> 将 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;J_0" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;J_0" title="J_0" /></a> 的后 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;32\&space;bits" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;32\&space;bits" title="32\ bits" /></a> 按 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;1\&space;mod\&space;2^{32}" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;1\&space;mod\&space;2^{32}" title="1\ mod\ 2^{32}" /></a> 递增；\
Step 4：在附加验证数据 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;$A$" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;$A$" title="$A$" /></a> 后面填充 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;v&space;=&space;128\lceil&space;\frac{lan(A)}{128}&space;\rceil&space;-&space;len(A)" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;v&space;=&space;128\lceil&space;\frac{lan(A)}{128}&space;\rceil&space;-&space;len(A)" title="v = 128\lceil \frac{lan(A)}{128} \rceil - len(A)" /></a> 个 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;0" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;0" title="0" /></a> ，密文 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;C" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;C" title="C" /></a> 后面填充 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;u&space;=&space;128\lceil&space;\frac{lan(C)}{128}&space;\rceil&space;-&space;len(C)" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;u&space;=&space;128\lceil&space;\frac{lan(C)}{128}&space;\rceil&space;-&space;len(C)" title="u = 128\lceil \frac{lan(C)}{128} \rceil - len(C)" /></a> 个 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;0" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;0" title="0" /></a> ，直至它们的长度都为 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;128\&space;bits" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;128\&space;bits" title="128\ bits" /></a> 的整数倍。将扩充后的附加验证数据 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;$A$" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;$A$" title="$A$" /></a> 添加到密文 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;C" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;C" title="C" /></a> 之前，再在扩充后的密文 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;C" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;C" title="C" /></a> 后增加 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;64\&space;bits" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;64\&space;bits" title="64\ bits" /></a> 来表示原始 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;$A$" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;$A$" title="$A$" /></a> 的长度，增加 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;64\&space;bits" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;64\&space;bits" title="64\ bits" /></a> 来表示原始 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;C" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;C" title="C" /></a> 的长度。\
Step 5：将 Step 4 得到的字符串使用子密钥 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;K" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;K" title="K" /></a> 通过 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;GHASH_H" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;GHASH_H" title="GHASH_H" /></a> 函数生成 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;S&space;=&space;GHASH_H(A&space;||&space;0^v&space;||&space;C&space;||&space;0^u&space;||&space;[len(A)]_{64}&space;||&space;[len(C)]_{64})" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;S&space;=&space;GHASH_H(A&space;||&space;0^v&space;||&space;C&space;||&space;0^u&space;||&space;[len(A)]_{64}&space;||&space;[len(C)]_{64})" title="S = GHASH_H(A || 0^v || C || 0^u || [len(A)]_{64} || [len(C)]_{64})" /></a>；\
Step 6：使用 Step 2 得到计数器的预设值 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;J_0" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;J_0" title="J_0" /></a> 通过 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;GCTR_K" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;GCTR_K" title="GCTR_K" /></a> 函数对 Step 5 得到的结果 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;S" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;S" title="S" /></a> 进行加密，并用 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;MSB_t" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;MSB_t" title="MSB_t" /></a> 函数取其密文的前 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;t\&space;bits" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;t\&space;bits" title="t\ bits" /></a> 得到最终的验证码 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;T&space;=&space;MSB_t(GCTR_K(J_0,S))" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;T&space;=&space;MSB_t(GCTR_K(J_0,S))" title="T = MSB_t(GCTR_K(J_0,S))" /></a>。\
Step 7：返回 Step 3 得到的密文 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;C" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;C" title="C" /></a> 和 Step 6 得到的验证码 <a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\dpi{100}&space;\fn_cs&space;T" target="_blank"><img src="https://latex.codecogs.com/png.latex?\inline&space;\dpi{100}&space;\fn_cs&space;T" title="T" /></a>。

![](https://github.com/Letty51/pictures/blob/master/GHASH.png)

![](https://github.com/Letty51/pictures/blob/master/GCTR.png)